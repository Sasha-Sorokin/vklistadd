name: Release

on:
  push:
    branches: [master, beta, alpha]

jobs:
  release:
    runs-on: ubuntu-latest

    if: >-
      !contains(github.event.head_commit.message, '[skip ci]')
      && !contains(github.event.head_commit.message, '[ci skip]')
      && !contains(github.event.head_commit.message, '[auto]')

    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: 16.x

      - name: Install dependencies
        run: npm ci

      - name: Release!
        id: do_release
        env:
          GITHUB_TOKEN: ${{ secrets.SEMANTIC_RELEASE_KEY }}
          GITHUB_OUTPUTS: "true"
        run: npx semantic-release

      - name: Dispatch publish
        if: ${{ steps.do_release.outputs.tag != null }}
        uses: benc-uk/workflow-dispatch@v1
        with:
          workflow: Publish
          token: ${{ secrets.SEMANTIC_RELEASE_KEY }}
          ref: refs/tags/${{ steps.do_release.outputs.tag }}
          inputs: |-
            {
              "trigger_ref": "${{ github.ref }}"
            }
